<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <title>갤럭시 카메라</title>
  
    
    <!-- 갤럭시 카메라 스타일 (검정 액션바) -->
    <style>
        /* 기본 리셋 및 스크롤 방지 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            background: #000;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        /* 기본 카메라 컨테이너 */
        .camera_warp {
            display: flex;
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            flex-wrap: wrap;
            overflow: hidden;
            background: #000;
            align-items: flex-start;
            justify-content: flex-start;
            position: fixed;
            top: 0;
            left: 0;
        }

        /* 상단 카메라 촬영 영역 (여백 완전 제거) */
        .shot_area {
            position: relative;
            height: calc(100vw / 3 * 4);
            box-sizing: border-box;
            background-color: #000;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            padding: 0;
            border: none;
            order: 1;
            flex-shrink: 0;
        }

        /* 비디오 전체화면 (여백 없이 꽉 채우기) */
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            margin: 0;
            padding: 0;
            border: none;
            display: block;
        }

        /* 캔버스 요소들도 여백 제거 */
        #canvas, #canvas_raw, #canvas_thumb {
            margin: 0;
            padding: 0;
            border: none;
            display: block;
        }

        /* 하단 검정 컨트롤 영역 (적절한 높이로 수정) */
        .control-wrap {
            height: calc(var(--vh, 1vh) * 100 - (100vw / 3 * 4));
            min-height: 120px;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            box-sizing: border-box;
            width: 100%;
            align-items: center;
            overflow: hidden;
            position: relative;
            order: 2;
            flex-shrink: 0;
            padding: 10px 0;
        }

        /* 줌 컨트롤을 검정색 바 영역으로 이동 */
        .zoom-controls {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            pointer-events: auto;
            flex-shrink: 0;
            margin-bottom: 10px;
        }

        .zoom-control-bar {
            display: flex;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 25px;
            padding: 4px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            gap: 2px;
        }

        .zoom-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 15px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 44px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .zoom-btn.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        /* 하단 검정 액션바 컨테이너 */
        .action-bar {
            width: 100%;
            height: auto;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 60px;
            padding: 0 20px;
            box-sizing: border-box;
            flex-shrink: 0;
            flex-grow: 1;
        }

        /* 썸네일 컨테이너 */
        .thumbnail-container {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
        }

        .thumbnail-container:active {
            transform: scale(0.95);
        }

        .thumbnail-placeholder {
            width: 100%;
            height: 100%;
            background: rgba(128, 128, 128, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .thumbnail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 갤럭시 스타일 촬영 버튼 */
        .capture-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: transparent;
            border: 6px solid white;
            cursor: pointer;
            position: relative;
            transition: all 0.1s ease;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .capture-btn:active {
            transform: scale(0.9);
            border-width: 8px;
        }

        .capture-btn-inner {
            width: 62px;
            height: 62px;
            border-radius: 50%;
            background: white;
            transition: all 0.1s ease;
        }

        .capture-btn:active .capture-btn-inner {
            width: 50px;
            height: 50px;
        }

        /* 모드 전환 버튼 영역 (오른쪽) */
        .mode-container {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 기존 CSS 참고 - 세로 모드 반응형 */
        
        /* 세로 모드 - 적절한 검정 영역 */
        @media (orientation: portrait) {
            /* 기본: 화면 전체를 카메라로 사용, 검정 바 적절한 크기 */
            .shot_area {
                height: calc(100vw / 3 * 4);
                width: 100vw;
                margin: 0;
                padding: 0;
            }
            .control-wrap {
                height: calc(var(--vh, 1vh) * 100 - (100vw / 3 * 4));
                min-height: 120px;
                max-height: 180px;
            }

            /* 큰 화면에서는 적절한 비율 유지하되 여백 최소화 */
            @media (min-width: 432px) {
                .shot_area {
                    height: calc(60vw / 3 * 4);
                    width: 60vw;
                    margin: 0 20vw;
                }
                .control-wrap {
                    height: calc(var(--vh, 1vh) * 100 - (60vw / 3 * 4));
                    min-height: 130px;
                    max-height: 200px;
                }
            }

            /* 태블릿은 좀 더 작은 비율 */
            @media (min-width: 768px) {
                .shot_area {
                    height: calc(50vw / 3 * 4);
                    width: 50vw;
                    margin: 0 25vw;
                }
                .control-wrap {
                    height: calc(var(--vh, 1vh) * 100 - (50vw / 3 * 4));
                    min-height: 150px;
                    max-height: 220px;
                }
                .capture-btn {
                    width: 70px;
                    height: 70px;
                    border-width: 5px;
                }
                .capture-btn-inner {
                    width: 54px;
                    height: 54px;
                }
                .thumbnail-container {
                    width: 50px;
                    height: 50px;
                }
                .zoom-btn {
                    padding: 6px 12px;
                    font-size: 13px;
                    min-width: 36px;
                }
            }

            /* 작은 화면에서는 버튼 크기 조정 */
            @media (max-width: 376px) {
                .capture-btn {
                    width: 50px;
                    height: 50px;
                    border-width: 3px;
                }
                .capture-btn-inner {
                    width: 38px;
                    height: 38px;
                }
                .thumbnail-container {
                    width: 35px;
                    height: 35px;
                }
                .zoom-btn {
                    padding: 4px 8px;
                    font-size: 12px;
                    min-width: 30px;
                }
            }
        }

        /* 가로모드 - 화면 비율에 맞게 조정 */
        @media (orientation: landscape) {
            .camera_warp {
                display: flex;
                width: 100vw;
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                flex-direction: row;
                overflow: hidden;
                background: #000;
                align-items: stretch;
                justify-content: flex-start;
                position: fixed;
                top: 0;
                left: 0;
            }
            
            /* 가로모드에서는 카메라가 화면 높이의 75% */
            .shot_area {
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                width: 75vw;
                margin: 0;
                padding: 0;
                order: 1;
                flex-shrink: 0;
                position: relative;
            }
            
            /* 가로모드에서 액션바는 오른쪽 25% */
            .control-wrap {
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                width: 25vw;
                min-width: 120px;
                background-color: #000;
                display: flex;
                flex-direction: column;
                justify-content: center;
                box-sizing: border-box;
                align-items: center;
                overflow: hidden;
                position: relative;
                order: 2;
                flex-shrink: 0;
                padding: 20px 10px;
                gap: 30px;
            }

            /* 가로모드에서 줌 컨트롤 */
            .zoom-controls {
                position: relative;
                width: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 100;
                pointer-events: auto;
                flex-shrink: 0;
                gap: 10px;
            }

            .zoom-control-bar {
                display: flex;
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            /* 가로모드에서 액션바 */
            .action-bar {
                width: 100%;
                height: auto;
                background-color: #000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 30px;
                padding: 0;
                box-sizing: border-box;
                flex-shrink: 0;
            }

            /* 가로모드 버튼 크기 조정 */
            .capture-btn {
                width: 60px;
                height: 60px;
                border-width: 4px;
            }
            .capture-btn-inner {
                width: 46px;
                height: 46px;
            }
            .thumbnail-container {
                width: 40px;
                height: 40px;
            }
            .zoom-btn {
                padding: 6px 10px;
                font-size: 14px;
                min-width: 32px;
                margin: 3px 0;
            }

            /* 작은 가로 화면 */
            @media (max-height: 480px) {
                .control-wrap {
                    padding: 15px 8px;
                    gap: 20px;
                    min-width: 100px;
                }
                .capture-btn {
                    width: 50px;
                    height: 50px;
                    border-width: 3px;
                }
                .capture-btn-inner {
                    width: 38px;
                    height: 38px;
                }
                .thumbnail-container {
                    width: 35px;
                    height: 35px;
                }
                .action-bar {
                    gap: 20px;
                }
                .zoom-btn {
                    padding: 4px 8px;
                    font-size: 12px;
                    min-width: 28px;
                }
                .zoom-controls {
                    gap: 8px;
                }
                .zoom-control-bar {
                    gap: 8px;
                }
            }

            /* 매우 작은 가로 화면 */
            @media (max-height: 400px) {
                .control-wrap {
                    padding: 10px 5px;
                    gap: 15px;
                    width: 20vw;
                    min-width: 90px;
                }
                .shot_area {
                    width: 80vw;
                }
                .action-bar {
                    gap: 15px;
                }
                .zoom-controls {
                    gap: 5px;
                }
                .zoom-control-bar {
                    gap: 5px;
                }
            }
        }

        /* iOS Safari 최적화 (완전한 화면 채우기) */
        @supports (-webkit-touch-callout: none) {
            .camera_warp {
                height: -webkit-fill-available;
                min-height: -webkit-fill-available;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                overflow: hidden;
            }

            body {
                height: -webkit-fill-available;
                min-height: -webkit-fill-available;
            }

            .shot_area {
                position: relative;
                overflow: hidden;
            }

            .control-wrap {
                overflow: hidden;
                position: relative;
            }
        }

        /* 모든 브라우저에서 스크롤바 숨기기 */
        ::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 삼성 브라우저 최적화 */
        @media screen and (-webkit-min-device-pixel-ratio: 2) {
            .zoom-control-bar {
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
            }
        }

        /* 사진 목록 팝업 */
        .photo-list-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
        }

        .photo-list-content {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .photo-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
            padding: 20px 0;
        }

        .photo-list-header h3 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 20px;
            transition: background 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            padding-bottom: 20px;
        }

        .photo-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .photo-item:active {
            transform: scale(0.95);
        }

        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .photo-item-info {
            padding: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            text-align: center;
        }

        /* 화면 회전 시 부드러운 전환 */
        * {
            transition: transform 0.3s ease;
        }

        /* 터치 최적화 */
        .zoom-btn, .capture-btn, .thumbnail-container {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
    <script src="../assets/js/jquery-ui.js"></script>
    <script type="text/javascript" src="../assets/js/common.js"></script>
</head>

<body>
    <div class="camera_warp">

        <div class="shot_area" id="captureArea">
            <video id="video" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; transform-origin: center;"></video>
            <canvas id="canvas"></canvas>
            <canvas id="canvas_raw"></canvas>
            <canvas id="canvas_thumb"></canvas>

            <div id="guideImg" style="display: none;">
                <img id="guide" src="../assets/img/transparent.png">
            </div>

        </div>
        
        <!-- 하단 검정 컨트롤 영역 -->
        <div class="control-wrap">
            <!-- 줌 컨트롤을 검정색 바 내부로 이동 -->
            <div class="zoom-controls">
                <div class="zoom-control-bar">
                    <button class="zoom-btn active" data-zoom="1" onclick="setZoom(1)">1×</button>
                    <button class="zoom-btn" data-zoom="2" onclick="setZoom(2)">2×</button>
                    <button class="zoom-btn" data-zoom="3" onclick="setZoom(3)">3×</button>
                </div>
            </div>
            
            <div class="action-bar">
                <!-- 썸네일 -->
                <div class="thumbnail-container" id="thumbnailContainer" onclick="showPhotoList()">
                    <div class="thumbnail-placeholder">
                        <span>📷</span>
                </div>
            </div>

                <!-- 촬영 버튼 -->
                <button class="capture-btn" id="captureBtn" onclick="capturePhoto()">
                    <div class="capture-btn-inner"></div>
                </button>

                <!-- 빈 공간 (대칭성을 위해) -->
                <div class="mode-container"></div>
        </div>
            </div>
    
    </div>


    <script>
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty("--vh", `${vh}px`);
        window.addEventListener("resize", () => {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty("--vh", `${vh}px`);
        });
    </script>



  <!-- 카메라 기능 스크립트 -->
  <script>
    let stream = null;
    let capturedImages = [];
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const canvasRaw = document.getElementById('canvas_raw');
    const canvasThumb = document.getElementById('canvas_thumb');
    const ctx = canvas.getContext('2d');
    const ctxRaw = canvasRaw.getContext('2d');
    const ctxThumb = canvasThumb.getContext('2d');

    // 페이지 로드 시 카메라 초기화
    document.addEventListener('DOMContentLoaded', function() {
      initCamera();
      initTouchControls();
    });

    // 터치 제어 초기화
    function initTouchControls() {
      const video = document.getElementById('video');
      let initialDistance = 0;
      let initialZoom = 1;

      // 핀치 줌 시작
      video.addEventListener('touchstart', function(e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          initialDistance = Math.hypot(
            touch1.clientX - touch2.clientX,
            touch1.clientY - touch2.clientY
          );
          initialZoom = currentZoom;
        }
      });

      // 핀치 줌 중
      video.addEventListener('touchmove', function(e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const currentDistance = Math.hypot(
            touch1.clientX - touch2.clientX,
            touch1.clientY - touch2.clientY
          );

          if (initialDistance > 0) {
            const scale = currentDistance / initialDistance;
            const newZoom = initialZoom * scale;
            currentZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
            applyZoom();
          }
        }
      });

      // 더블 탭으로 줌 토글
      let lastTap = 0;
      video.addEventListener('touchend', function(e) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 500 && tapLength > 0 && e.touches.length === 0) {
          e.preventDefault();
          // 더블 탭: 줌 토글 (1x <-> 2x)
          currentZoom = currentZoom === 1 ? 2 : 1;
          applyZoom();
        }
        lastTap = currentTime;
      });
    }

    // 카메라 초기화
    async function initCamera() {
      try {
        // 카메라 권한 요청 및 스트림 가져오기 (갤럭시 카메라 수준의 고화질)
        const constraints = {
          video: {
            facingMode: 'environment', // 후면 카메라 우선 (모바일)
            width: { ideal: 3840, min: 1920 }, // 4K 우선, 최소 FHD
            height: { ideal: 2160, min: 1080 },
            frameRate: { ideal: 30, min: 15 }, // 부드러운 프레임률
            aspectRatio: { ideal: 16/9 } // 갤럭시 카메라 비율
          },
          audio: false
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        // 비디오 로드 후 실제 해상도 정보 출력
        video.addEventListener('loadedmetadata', function() {
          console.log(`카메라 해상도: ${video.videoWidth}x${video.videoHeight}`);
          console.log(`디스플레이 크기: ${video.clientWidth}x${video.clientHeight}`);
          adjustVideoDisplay();
        });

        // 비디오가 로드되면 캔버스 크기 설정
        video.addEventListener('loadedmetadata', function() {
          resizeCanvas();
        });

        // 화면 방향 변경시 디스플레이 재조정 (개선된 버전)
        let resizeTimeout;
        
        function handleResize() {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            adjustVideoDisplay();
            resizeCanvas();
            
            // iOS Safari의 경우 추가 조정
            if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
              setTimeout(() => {
                adjustVideoDisplay();
              }, 300);
            }
          }, 150);
        }

        window.addEventListener('orientationchange', handleResize);
        window.addEventListener('resize', handleResize);
        
        // 모바일 디바이스 특별 처리 (스크롤 완전 방지)
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
          // 스크롤 완전 차단
          function preventScroll(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }

          // 모든 스크롤 이벤트 차단
          document.addEventListener('scroll', preventScroll, { passive: false });
          document.addEventListener('touchmove', preventScroll, { passive: false });
          document.addEventListener('wheel', preventScroll, { passive: false });
          
          // 바디와 문서 스크롤 강제로 0으로 유지
          setInterval(function() {
            if (document.body.scrollTop !== 0) document.body.scrollTop = 0;
            if (document.documentElement.scrollTop !== 0) document.documentElement.scrollTop = 0;
            if (window.scrollY !== 0) window.scrollTo(0, 0);
          }, 100);

          // iOS Safari 주소창 숨기기
          function hideAddressBar() {
            if (window.scrollY === 0) {
              window.scrollTo(0, 1);
              setTimeout(() => window.scrollTo(0, 0), 0);
            }
          }

          document.addEventListener('touchstart', hideAddressBar, { passive: true });
        window.addEventListener('orientationchange', function() {
            setTimeout(hideAddressBar, 100);
          });
        }

        // 모든 스크롤 방지 (데스크탑 포함)
        document.addEventListener('DOMContentLoaded', function() {
          document.body.style.overflow = 'hidden';
          document.documentElement.style.overflow = 'hidden';
          
          // 키보드 방향키 스크롤도 방지
          window.addEventListener('keydown', function(e) {
            if([32, 33, 34, 35, 36, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
              e.preventDefault();
            }
          }, false);
        });

      } catch (error) {
        console.error('카메라 접근 오류:', error);
        alert('카메라에 접근할 수 없습니다. 카메라 권한을 확인해주세요.');
        
        // 후면 카메라가 없는 경우 전면 카메라 시도
        if (error.name === 'OverconstrainedError') {
          try {
            const fallbackConstraints = {
              video: {
                facingMode: 'user', // 전면 카메라
                width: { ideal: 2560, min: 1280 }, // 전면도 고화질
                height: { ideal: 1440, min: 720 },
                frameRate: { ideal: 30, min: 15 },
                aspectRatio: { ideal: 16/9 }
              },
              audio: false
            };
            stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
            video.srcObject = stream;
            
            video.addEventListener('loadedmetadata', function() {
              console.log(`전면 카메라 해상도: ${video.videoWidth}x${video.videoHeight}`);
              adjustVideoDisplay();
            });
          } catch (fallbackError) {
            console.error('전면 카메라 접근 오류:', fallbackError);
          }
        }
      }
    }

    // 비디오 디스플레이 조정 (갤럭시 카메라처럼)
    function adjustVideoDisplay() {
      const video = document.getElementById('video');
      const container = document.querySelector('.shot_area');
      
      if (video.videoWidth && video.videoHeight) {
        const videoAspectRatio = video.videoWidth / video.videoHeight;
        const containerAspectRatio = container.clientWidth / container.clientHeight;
        
        // 갤럭시 카메라처럼 화면을 꽉 채우되 비율 유지
        if (videoAspectRatio > containerAspectRatio) {
          // 비디오가 더 넓은 경우: 높이를 맞춤
          video.style.width = 'auto';
          video.style.height = '100%';
          video.style.objectFit = 'cover';
        } else {
          // 비디오가 더 높은 경우: 너비를 맞춤
          video.style.width = '100%';
          video.style.height = 'auto';
          video.style.objectFit = 'cover';
        }
        
        // 캔버스도 동일하게 설정
        resizeCanvas();
      }
    }

    // 캔버스 크기 조정 (숨김 상태로 변경)
    function resizeCanvas() {
      if (video.videoWidth && video.videoHeight) {
        const containerWidth = document.querySelector('.shot_area').clientWidth;
        const containerHeight = document.querySelector('.shot_area').clientHeight;
        
        // 캔버스를 숨김 상태로 설정하고 실제 비디오 크기로 맞춤
        [canvas, canvasRaw, canvasThumb].forEach(c => {
          c.width = video.videoWidth;
          c.height = video.videoHeight;
          c.style.display = 'none'; // 캔버스 숨김
        });

        // 썸네일 캔버스만 작게 설정
        const aspectRatio = video.videoWidth / video.videoHeight;
        canvasThumb.width = 300;
        canvasThumb.height = 300 / aspectRatio;
      }
    }

    // 사진 촬영
    function capturePhoto() {
      if (!video.videoWidth || !video.videoHeight) {
        alert('카메라가 준비되지 않았습니다.');
        return;
      }

      try {
        // 현재 비디오 상태 (줌, 필터 등)를 반영한 캡처
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        
        // 임시 캔버스를 비디오 크기로 설정
        tempCanvas.width = video.videoWidth;
        tempCanvas.height = video.videoHeight;
        
        // 필터 적용
        if (video.style.filter) {
          tempCtx.filter = video.style.filter;
        }
        
        // 줌이 적용된 상태로 캡처
        if (currentZoom > 1) {
          const scaledWidth = video.videoWidth / currentZoom;
          const scaledHeight = video.videoHeight / currentZoom;
          const offsetX = (video.videoWidth - scaledWidth) / 2;
          const offsetY = (video.videoHeight - scaledHeight) / 2;
          
          tempCtx.drawImage(video, offsetX, offsetY, scaledWidth, scaledHeight, 0, 0, video.videoWidth, video.videoHeight);
        } else {
          tempCtx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
        }

        // 원본 해상도로 캡처 (임시 캔버스에서)
        canvasRaw.width = video.videoWidth;
        canvasRaw.height = video.videoHeight;
        ctxRaw.drawImage(tempCanvas, 0, 0);

        // 화면 표시용 캡처
        ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);

        // 썸네일 생성
        ctxThumb.drawImage(tempCanvas, 0, 0, canvasThumb.width, canvasThumb.height);

        // 이미지 데이터 저장
        const imageData = canvasRaw.toDataURL('image/jpeg', 0.9);
        const thumbData = canvasThumb.toDataURL('image/jpeg', 0.7);
        
        const captureInfo = {
          id: Date.now(),
          timestamp: new Date().toLocaleString(),
          fullImage: imageData,
          thumbnail: thumbData
        };

        capturedImages.push(captureInfo);
        
        // 촬영 효과 (화면 깜빡임)
        showCaptureEffect();
        
        // 썸네일 업데이트
        updateThumbnail(captureInfo.thumbnail);
        
        // 성공 메시지
        console.log('사진이 촬영되었습니다:', captureInfo.timestamp);
        
        // 로컬 스토리지에 저장
        localStorage.setItem('capturedImages', JSON.stringify(capturedImages));
        
      } catch (error) {
        console.error('촬영 오류:', error);
        alert('사진 촬영 중 오류가 발생했습니다.');
      }
    }

    // 촬영 효과
    function showCaptureEffect() {
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.backgroundColor = 'white';
      overlay.style.opacity = '0.8';
      overlay.style.zIndex = '9999';
      overlay.style.pointerEvents = 'none';
      
      document.body.appendChild(overlay);
      
      setTimeout(() => {
        document.body.removeChild(overlay);
      }, 150);
    }



    // 줌 레벨 관리 (갤럭시 스타일)
    let currentZoom = 1;
    const zoomLevels = [1, 2, 3]; // 갤럭시 카메라 표준 줌 레벨

    // 특정 줌 레벨로 설정
    function setZoom(zoomLevel) {
      currentZoom = zoomLevel;
      applyZoom();
      updateZoomButtons();
      console.log(`줌 설정: ${currentZoom}x`);
    }

    // 줌 버튼 활성화 상태 업데이트
    function updateZoomButtons() {
      document.querySelectorAll('.zoom-btn').forEach(btn => {
        const zoom = parseInt(btn.dataset.zoom);
        if (zoom === currentZoom) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // 줌 적용
    function applyZoom() {
      const video = document.getElementById('video');
      video.style.transform = `scale(${currentZoom})`;
      
      // 부드러운 줌 애니메이션
      video.style.transition = 'transform 0.3s ease-out';
      setTimeout(() => {
        video.style.transition = '';
      }, 300);
    }

    // 레거시 함수들 (기존 터치 제스처 호환성)
    function zoomIn() {
      const currentIndex = zoomLevels.indexOf(currentZoom);
      if (currentIndex < zoomLevels.length - 1) {
        setZoom(zoomLevels[currentIndex + 1]);
      }
    }

    function zoomOut() {
      const currentIndex = zoomLevels.indexOf(currentZoom);
      if (currentIndex > 0) {
        setZoom(zoomLevels[currentIndex - 1]);
      }
    }

    // 밝기 조절
    function adjustBrightness(delta) {
      const currentFilter = video.style.filter || '';
      const brightnessMatch = currentFilter.match(/brightness\(([^)]+)\)/);
      let currentBrightness = brightnessMatch ? parseFloat(brightnessMatch[1]) : 1;
      
      currentBrightness = Math.max(0.3, Math.min(2, currentBrightness + delta));
      video.style.filter = currentFilter.replace(/brightness\([^)]+\)/, '') + ` brightness(${currentBrightness})`;
    }

    // 썸네일 업데이트
    function updateThumbnail(thumbnailData) {
      const container = document.getElementById('thumbnailContainer');
      const placeholder = container.querySelector('.thumbnail-placeholder');
      
      if (placeholder) {
        // 기존 placeholder 제거하고 실제 이미지로 교체
        placeholder.remove();
        const img = document.createElement('img');
        img.src = thumbnailData;
        img.className = 'thumbnail-image';
        img.alt = '최근 촬영 사진';
        container.appendChild(img);
      } else {
        // 기존 이미지 업데이트
        const existingImg = container.querySelector('.thumbnail-image');
        if (existingImg) {
          existingImg.src = thumbnailData;
        }
      }
    }

    // 갤럭시 스타일 사진 목록 표시
    function showPhotoList() {
      if (capturedImages.length === 0) {
        alert('촬영된 사진이 없습니다.');
        return;
      }
      
      // 기존 팝업 제거
      const existingPopup = document.querySelector('.photo-list-popup');
      if (existingPopup) {
        existingPopup.remove();
      }
      
      const popup = document.createElement('div');
      popup.className = 'photo-list-popup';
      popup.style.display = 'flex';
      popup.style.alignItems = 'flex-start';
      popup.style.justifyContent = 'center';
      popup.style.paddingTop = '20px';
      
      popup.innerHTML = `
        <div class="photo-list-content">
          <div class="photo-list-header">
            <h3>갤러리 (${capturedImages.length}장)</h3>
            <button class="close-btn" onclick="closePhotoList()">✕</button>
          </div>
          <div class="photo-grid">
            ${capturedImages.map((img, index) => `
              <div class="photo-item" onclick="viewPhoto(${index})">
                <img src="${img.thumbnail}" alt="사진 ${index + 1}">
                <div class="photo-item-info">
                  <div>${img.timestamp}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      document.body.appendChild(popup);
    }

    // 사진 목록 닫기
    function closePhotoList() {
      const popup = document.querySelector('.photo-list-popup');
      if (popup) {
        popup.remove();
      }
    }

    // 개별 사진 보기
    function viewPhoto(index) {
      const img = capturedImages[index];
      if (!img) return;
      
      const viewer = document.createElement('div');
      viewer.style.position = 'fixed';
      viewer.style.top = '0';
      viewer.style.left = '0';
      viewer.style.width = '100%';
      viewer.style.height = '100%';
      viewer.style.background = 'rgba(0, 0, 0, 0.95)';
      viewer.style.zIndex = '1001';
      viewer.style.display = 'flex';
      viewer.style.alignItems = 'center';
      viewer.style.justifyContent = 'center';
      viewer.style.flexDirection = 'column';
      viewer.style.padding = '20px';
      
      viewer.innerHTML = `
        <div style="position: relative; max-width: 90%; max-height: 80%;">
          <img src="${img.fullImage}" style="width: 100%; height: 100%; object-fit: contain;">
        </div>
        <div style="margin-top: 20px; display: flex; gap: 15px;">
          <button onclick="downloadImage(${index})" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">다운로드</button>
          <button onclick="deleteImage(${index})" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">삭제</button>
          <button onclick="this.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">닫기</button>
        </div>
      `;
      
      // 배경 클릭시 닫기
      viewer.addEventListener('click', function(e) {
        if (e.target === viewer) {
          viewer.remove();
        }
      });
      
      document.body.appendChild(viewer);
    }



    // 이미지 다운로드
    function downloadImage(index) {
      const img = capturedImages[index];
      const link = document.createElement('a');
      link.download = `photo_${img.id}.jpg`;
      link.href = img.fullImage;
      link.click();
    }

    // 이미지 삭제
    function deleteImage(index) {
      if (confirm('이 사진을 삭제하시겠습니까?')) {
        capturedImages.splice(index, 1);
        localStorage.setItem('capturedImages', JSON.stringify(capturedImages));
        // 팝업 새로고침
        document.querySelector('div[style*="position: fixed"]').remove();
        showPhotoList();
      }
    }



    // 페이지 언로드시 카메라 스트림 정리
    window.addEventListener('beforeunload', function() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    });

    // 로컬 스토리지에서 이전 촬영 이미지 복원
    function restoreSavedImages() {
      const savedImages = localStorage.getItem('capturedImages');
      if (savedImages) {
        try {
          capturedImages = JSON.parse(savedImages);
          
          // 가장 최근 사진을 썸네일로 표시
          if (capturedImages.length > 0) {
            const lastImage = capturedImages[capturedImages.length - 1];
            updateThumbnail(lastImage.thumbnail);
          }
        } catch (error) {
          console.error('저장된 이미지 복원 오류:', error);
        }
      }
    }

    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', function() {
      restoreSavedImages();
    });
  </script>
</body>

</html>